name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5
        with:
          gradle-home-cache-cleanup: true

      - name: Cache Kotlin Native
        uses: actions/cache@v4
        with:
          path: ~/.konan
          key: ${{ runner.os }}-konan-${{ hashFiles('gradle/libs.versions.toml') }}
          restore-keys: ${{ runner.os }}-konan-

      - name: Run Detekt
        run: ./gradlew detekt --continue

      # Android Lint disabled due to Kotlin 2.3.0 compatibility issue
      # https://issuetracker.google.com/issues/356028371
      # - name: Run Android Lint
      #   run: ./gradlew :androidApp:lint --continue

      - name: Upload Detekt Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: detekt-reports
          path: '**/build/reports/detekt/'

  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5
        with:
          gradle-home-cache-cleanup: true

      - name: Cache Kotlin Native
        uses: actions/cache@v4
        with:
          path: ~/.konan
          key: ${{ runner.os }}-konan-${{ hashFiles('gradle/libs.versions.toml') }}
          restore-keys: ${{ runner.os }}-konan-

      - name: Run Unit Tests
        run: ./gradlew test

      - name: Generate Coverage Report
        run: ./gradlew koverXmlReport
        continue-on-error: true

      - name: Upload Test Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-reports
          path: |
            **/build/reports/tests/
            **/build/reports/kover/

  build-debug:
    name: Build Debug APK
    runs-on: ubuntu-latest
    needs: [lint, test]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5
        with:
          gradle-home-cache-cleanup: true

      - name: Cache Kotlin Native
        uses: actions/cache@v4
        with:
          path: ~/.konan
          key: ${{ runner.os }}-konan-${{ hashFiles('gradle/libs.versions.toml') }}
          restore-keys: ${{ runner.os }}-konan-

      - name: Build Debug APK
        run: ./gradlew :androidApp:assembleDebug

      - name: Upload Debug APK
        uses: actions/upload-artifact@v4
        with:
          name: debug-apk
          path: androidApp/build/outputs/apk/debug/*.apk

  firebase-distribution:
    name: Firebase App Distribution
    runs-on: ubuntu-latest
    needs: [build-debug]
    steps:
      - name: Check Firebase secrets
        id: check-secrets
        run: |
          if [ -z "${{ secrets.FIREBASE_APP_ID }}" ] || [ -z "${{ secrets.FIREBASE_SERVICE_ACCOUNT_JSON }}" ]; then
            echo "configured=false" >> $GITHUB_OUTPUT
            echo "::warning::Firebase secrets not configured. Skipping distribution."
          else
            echo "configured=true" >> $GITHUB_OUTPUT
          fi

      - name: Checkout
        if: steps.check-secrets.outputs.configured == 'true'
        uses: actions/checkout@v4

      - name: Download Debug APK
        if: steps.check-secrets.outputs.configured == 'true'
        uses: actions/download-artifact@v4
        with:
          name: debug-apk
          path: ./apk

      - name: Find APK file
        if: steps.check-secrets.outputs.configured == 'true'
        id: find-apk
        run: |
          APK_PATH=$(find ./apk -name "*.apk" | head -n 1)
          echo "apk_path=$APK_PATH" >> $GITHUB_OUTPUT

      - name: Generate release notes
        if: steps.check-secrets.outputs.configured == 'true'
        id: release-notes
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            NOTES="PR #${{ github.event.pull_request.number }}: ${{ github.event.pull_request.title }}"
          else
            NOTES="Push to ${{ github.ref_name }}"
          fi
          echo "notes<<EOF" >> $GITHUB_OUTPUT
          echo "$NOTES" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "Commit: ${{ github.sha }}" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Upload to Firebase App Distribution
        if: steps.check-secrets.outputs.configured == 'true'
        continue-on-error: true  # Don't fail build if Firebase upload fails
        uses: wzieba/Firebase-Distribution-Github-Action@v1.7.0
        with:
          appId: ${{ secrets.FIREBASE_APP_ID }}
          serviceCredentialsFileContent: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_JSON }}
          groups: testers
          file: ${{ steps.find-apk.outputs.apk_path }}
          releaseNotes: ${{ steps.release-notes.outputs.notes }}
